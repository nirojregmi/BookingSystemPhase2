
// ===============================
// 1) DOM references
// ===============================
const actions = document.getElementById("resourceActions");
const resourceNameContainer = document.getElementById("resourceNameContainer");

// Example roles
const role = "admin"; // "reserver" | "admin"

// Will hold a reference to the Create button so we can enable/disable it
let createButton = null;

// ===============================
// 2) Button creation helpers
// ===============================

const BUTTON_BASE_CLASSES =
  "w-full rounded-2xl px-6 py-3 text-sm font-semibold transition-all duration-200 ease-out";

const BUTTON_ENABLED_CLASSES =
  "bg-brand-primary text-white hover:bg-brand-dark/80 shadow-soft";

const BUTTON_DISABLED_CLASSES =
  "cursor-not-allowed opacity-50";


// ===============================
// Validation helpers (Task 2)
// ===============================

function getActionInputs() {
  const form = document.getElementById("resourceForm");
  if (!form) return [];
  return form.querySelectorAll("input, textarea, select");
}


function isMeaningful(value) {
  return typeof value === "string"
    ? value.trim().length > 0
    : value !== null && value !== undefined;
}

function validateCreateForm() {
  if (!createButton) return;

  const fields = getActionInputs();
  let ok = true;

  fields.forEach((el) => {
    // Ignore hidden/disabled fields
    if (el.disabled) return;
    if (el.type === "hidden") return;

    if (el.type === "number") {
      const v = el.value.trim();
      if (v.length === 0 || Number.isNaN(Number(v))) ok = false;
    } else if (el.type === "checkbox" || el.type === "radio") {
      if (!el.checked) ok = false;
    } else {
      if (el.value.trim().length === 0) ok = false;
    }
  });

  createButton.disabled = !ok;
}


function addButton({ label, type = "button", value, classes = "" }) {
  const btn = document.createElement("button");
  btn.type = type;
  btn.textContent = label;
  btn.name = "action";
  if (value) btn.value = value;

  btn.className = `${BUTTON_BASE_CLASSES} ${classes}`.trim();

  actions.appendChild(btn);
  return btn;
}

function setButtonEnabled(btn, enabled) {
  if (!btn) return;

  btn.disabled = !enabled;

  // Keep disabled look in ONE place (here)
  btn.classList.toggle("cursor-not-allowed", !enabled);
  btn.classList.toggle("opacity-50", !enabled);

  // Optional: remove hover feel when disabled (recommended UX)
  if (!enabled) {
    btn.classList.remove("hover:bg-brand-dark/80");
  } else {
    // Only re-add if this button is supposed to have it
    // (for Create we know it is)
    if (btn.value === "create" || btn.textContent === "Create") {
      btn.classList.add("hover:bg-brand-dark/80");
    }
  }
}

// Add these near your other globals (top of file)
let updateButton = null;
let deleteButton = null;

function renderActionButtons(currentRole) {
  // Clear old buttons (prevents duplicates if called again)
  actions.innerHTML = "";

  // Reset refs
  createButton = null;
  updateButton = null;
  deleteButton = null;

  if (currentRole === "reserver") {
    createButton = addButton({
      label: "Create",
      type: "submit",
      classes: BUTTON_ENABLED_CLASSES,
    });

    // Task 2: Disable by default
    createButton.disabled = true;

    getActionInputs().forEach((el) => {
      el.addEventListener("input", validateCreateForm);
      el.addEventListener("change", validateCreateForm);
    });

    validateCreateForm();

    // Default: disabled until valid
    setButtonEnabled(createButton, false);
    return;
  }

  if (currentRole === "admin") {
    createButton = addButton({
      label: "Create",
      type: "submit",
      value: "create",
      classes: BUTTON_ENABLED_CLASSES,
    });

    updateButton = addButton({
      label: "Update",
      value: "update",
      classes: BUTTON_ENABLED_CLASSES,
    });

    deleteButton = addButton({
      label: "Delete",
      value: "delete",
      classes: BUTTON_ENABLED_CLASSES,
    });

    // Task 2: Disable Create by default
    createButton.disabled = true;

    getActionInputs().forEach((el) => {
      el.addEventListener("input", validateCreateForm);
      el.addEventListener("change", validateCreateForm);
    });

    validateCreateForm();

    // Default: buttons disabled until valid
    setButtonEnabled(createButton, false);
    setButtonEnabled(updateButton, false);
    setButtonEnabled(deleteButton, false);
  }
}



  // Default: Buttons are disabled until validation says it's OK
  setButtonEnabled(createButton, false);
 setButtonEnabled(updateButton, false);
  setButtonEnabled(deleteButton, false);
}

// ===============================
// 3) Input creation + validation
// ===============================
function createResourceNameInput(container) {
  const input = document.createElement("input");

  // Core attributes
  input.id = "resourceName";
  input.name = "resourceName";
  input.type = "text";
  input.placeholder = "e.g., Meeting Room A";

  // Base Tailwind styling (single source of truth)
  input.className = `
    mt-2 w-full rounded-2xl border border-black/10 bg-white
    px-4 py-3 text-sm outline-none
    focus:border-brand-blue focus:ring-2 focus:ring-brand-blue/30
    transition-all duration-200 ease-out
  `;

  container.appendChild(input);
  return input;
}

function isResourceNameValid(value) {
  const trimmed = value.trim();

  // Allowed: letters, numbers, Finnish letters, and space (based on your current regex)
  const allowedPattern = /^[a-zA-Z0-9äöåÄÖÅ ]+$/;

  const lengthValid = trimmed.length >= 5 && trimmed.length <= 30;
  const charactersValid = allowedPattern.test(trimmed);

  return lengthValid && charactersValid;
}

function setInputVisualState(input, state) {
  // Reset to neutral base state (remove only our own validation-related classes)
  input.classList.remove(
    "border-green-500",
    "bg-green-100",
    "focus:ring-green-500/30",
    "border-red-500",
    "bg-red-100",
    "focus:ring-red-500/30",
    "focus:border-brand-blue",
    "focus:ring-brand-blue/30"
  );

  // Ensure base focus style is present when neutral
  // (If we are valid/invalid, we override ring color but keep ring behavior)
  input.classList.add("focus:ring-2");

  if (state === "valid") {
    input.classList.add("border-green-500", "bg-green-100", "focus:ring-green-500/30");
  } else if (state === "invalid") {
    input.classList.add("border-red-500", "bg-red-100", "focus:ring-red-500/30");
  } else {
    // neutral: keep base border/bg; nothing else needed
  }
}

function attachResourceNameValidation(input) {
  const update = () => {
    const raw = input.value;
    if (raw.trim() === "") {
      setInputVisualState(input, "neutral");
      setButtonEnabled(createButton, false);
      return;
    }

    const valid = isResourceNameValid(raw);

    setInputVisualState(input, valid ? "valid" : "invalid");
    setButtonEnabled(createButton, valid);
  };

  // Real-time validation
  input.addEventListener("input", update);

  // Initialize state on page load (Create disabled until valid)
  update();
}

// ===============================
// 4) Bootstrapping
// ===============================
renderActionButtons(role);

// Create + validate input
const resourceNameInput = createResourceNameInput(resourceNameContainer);
attachResourceNameValidation(resourceNameInput);

// ===============================
// Task 3: Clean values + block invalid submit
// ===============================

const resourceForm = document.getElementById("resourceForm");

if (resourceForm) {
  resourceForm.addEventListener("submit", function (e) {
    e.preventDefault(); // Stop normal submit

    // Re-run validation
    validateCreateForm();

    if (createButton?.disabled) {
      alert("Please fill all required fields correctly.");
      return;
    }

    // Clean values before sending
    const nameInput = document.getElementById("resourceName");
    if (nameInput) {
      nameInput.value = nameInput.value.trim();
    }

    const descriptionInput = document.getElementById("resourceDescription");
    if (descriptionInput) {
      descriptionInput.value = descriptionInput.value.trim();
    }

    const priceInput = document.querySelector('#resourceForm input[type="number"]');
    if (priceInput) {
      priceInput.value = priceInput.value.trim();
    }

    const timeUnitInput = document.querySelector('#resourceForm input[name="timeUnit"]:checked');

    // Build clean payload
    const payload = {
      name: nameInput?.value,
      description: descriptionInput?.value,
      price: Number(priceInput?.value),
      timeUnit: timeUnitInput?.value
    };

    console.log("✅ Clean payload ready:", payload);

    // Simulate success (since no backend yet)
    alert("Resource would be sent to backend successfully.");
  });
}
